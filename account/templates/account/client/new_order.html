{% extends "base.html" %}

{% block title %}Редактировать профиль{% endblock %}

{% block content %}
    <h1>Создать новый заказ</h1>
    <p>Заполните форму и прикрепите документы</p>
    <form method="post" enctype="multipart/form-data" id="orderForm" data-url="{% url 'load_data' %}">
        <p>Номер заказа: {{order_number}}</p>
        <p>Заказчик: {{profile}}</p>
        <p>Код заказчика: {{ request.user.id }}</p>

        {% for field in order_form %}
            <div id="field-{{ field.name }}" {% if field.name == 'mask_name' %}style="display: none;"{% endif %}>
                <p>
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <span class="help-icon" style="cursor: pointer;" onclick="showHelpText('{{ field.help_text|escapejs }}')">
                            &#x3F;
                        </span>
                    {% endif %}
                    {% for error in field.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </p>
            </div>
        {% endfor %}

        {% if order_form.instance.multiplan_dicing_plan_file %}
        <p>Загруженный файл:
            <a href="{{ order_form.instance.multiplan_dicing_plan_file.url }}" target="_blank">
                {{ order_form.instance.multiplan_dicing_plan_file.name }}
            </a>
        </p>
        {% endif %}
        {% csrf_token %}
        <p><input type="submit" value="Сохранить"></p>
    </form>

    <div id="helpModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
        <h4>Подсказка</h4>
        <p id="helpText"></p>
        <button id="closeHelpBtn">Закрыть</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        $(document).ready(function () {
            function toggleMaskNameField() {
                const orderType = $("#id_order_type").val();
                const maskNameField = $("#field-mask_name");
                const maskNameInput = $("#id_mask_name");
                
                if (orderType === "REP") {
                    maskNameField.show();
                    maskNameInput.prop("required", true);
                    maskNameInput.css("display", "");
                } else {
                    maskNameField.hide();
                    maskNameInput.prop("required", false);
                    maskNameInput.val("");
                }
            }

            $("#id_order_type").change(function () {
                toggleMaskNameField();
            });

            toggleMaskNameField();


            window.showHelpText = function(text) {
                document.getElementById('helpText').innerText = text;
                document.getElementById('helpModal').style.display = 'block';
            }

            $('#closeHelpBtn').click(function () {
                $('#helpModal').hide();
            });

            function toggleMultiplanFileField() {
                const choiceField = $("#id_multiplan_dicing_plan");
                const fileField = $("#id_multiplan_dicing_plan_file").closest("p");
                if (choiceField.prop("checked")) {
                    fileField.show();
                } else {
                    fileField.hide();
                }
            }
        
            toggleMultiplanFileField();

            $("#id_multiplan_dicing_plan").change(function () {
                toggleMultiplanFileField();
            });

            function loadSubstrates() {
                const substrate_type = $("#id_substrate_type").val();
                const url = $("#orderForm").attr("data-url");

                $.ajax({
                    url: url,
                    data: {
                        'substrate_type': substrate_type
                    },
                    success: function (data) {
                        $("#id_selected_thickness").html('<option value="">---------</option>');
                        $("#id_selected_diameter").html('<option value="">---------</option>');
                        data.thicknesses.forEach(function (thickness) {
                            $("#id_selected_thickness").append(
                                '<option value="' + thickness.id + '">' + thickness.value + '</option>'
                            );
                        });

                        data.diameters.forEach(function (diameter) {
                            $("#id_selected_diameter").append(
                                '<option value="' + diameter.id + '">' + diameter.value + '</option>'
                            );
                        });
                    },
                    error: function () {
                        $("#id_selected_thickness").html('<option value="">---------</option>');
                        $("#id_selected_diameter").html('<option value="">---------</option>');
                    }
                });
            }

            function loadContainerForCrystals() {
                const wafer_deliver_format = $("#id_wafer_deliver_format").val();
                const substrate_type = $("#id_substrate_type").val();
                const url = $("#orderForm").attr("data-url");

                $.ajax({
                    url: url,
                    data: {
                        'wafer_deliver_format': wafer_deliver_format,
                        'substrate_type': substrate_type
                    },
                    success: function (data) {
                        $("#id_container_for_crystals").html('<option value="">---------</option>');
                        data.container_for_crystals.forEach(function (container) {
                            $("#id_container_for_crystals").append(
                                '<option value="' + container.id + '">' + container.value + '</option>'
                            );
                        });
                    },
                    error: function () {
                        $("#id_container_for_crystals").html('<option value="">---------</option>');
                    }
                });
            }

            $("#id_wafer_deliver_format").change(function () {
                loadContainerForCrystals();
            });

            $("#id_substrate_type").change(function () {
                loadSubstrates();
            });
            
            if ($("#id_wafer_deliver_format").val()) {
                loadContainerForCrystals();
            }

            if ($("#id_substrate_type").val()) {
                loadSubstrates();
            }

            if (localStorage.getItem('substrate_type')) {
                const substrate_type = localStorage.getItem('substrate_type');
                $("#id_substrate_type").val(substrate_type).trigger("change");
            }

            $("#id_substrate_type").change(function () {
                localStorage.setItem('substrate_type', $(this).val());
            });

            $("#id_selected_thickness").change(function () {
                localStorage.setItem('thickness', $(this).val());
            });

            $("#id_selected_diameter").change(function () {
                localStorage.setItem('diameter', $(this).val());
            });
        });
    </script>
{% endblock %}
