{% extends "base.html" %}

{% block title %}Личный кабинет исполнителя{% endblock %}

{% block content %}
    <h1>Личный кабинет <span class="caps">технологической площадки</span></h1>
    {# TODO: ошибка в модели, в code_company лежит значение name_company и наоборот #}
    <h2>Компания: {{ data.code_company }}</h2>
    <div class="header_content">
    </div>
    <br>
    <h2>Перечень заказов:</h2>
    <div class="block_search">
        <form method="get" action="{% url 'executor_orders' %}">
            <input type="text" name="q" class="input_text" placeholder="Поиск по любым параметрам заказа" value="{{ request.GET.q }}">
            <button class="search-button" type="submit">Поиск</button>
        </form>
    </div>
    <div class="filter-block">
        <form method="get" action="{% url 'executor_orders' %}" class="filter-form">
            {% if request.GET.q %}
                <input type="hidden" name="q" value="{{ request.GET.q }}">
            {% endif %}
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label class="filter-label">Сортировать по:</label>
                    <select name="filter_by" class="filter-select">
                        <option value="">Выберите фильтр...</option>
                        <option value="order_number" {% if request.GET.filter_by == "order_number" %}selected{% endif %}>По номеру заказа</option>
                        <option value="status" {% if request.GET.filter_by == "status" %}selected{% endif %}>По статусу заказа</option>
                        <option value="created_at" {% if request.GET.filter_by == "created_at" %}selected{% endif %}>По дате создания</option>
                    </select>
                </div>        
                <div class="filter-actions">
                    <button type="submit" class="apply-button">Применить</button>
                    {% if request.GET.filter_by or request.GET.q %}
                        <a href="{% url 'executor_orders' %}" class="reset-button">
                            Сбросить фильтры
                        </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
    <div class="order-table-wrapper">
        <table border="1" class="order-table">
            <tr>
                <th scope="col">Номер заказа</th>
                <th scope="col">Статус заказа</th>
                <th scope="col">ID заказа</th>
                <th scope="col">Тип заказа</th>
                <th scope="col">Дата формирования заявки</th>
                <th scope="col">Срок выполнения по договору</th>
                <th scope="col">Дата оплаты</th>
                <th scope="col">Договор</th>
                <th scope="col">Счет</th>
            </tr>
            {% if not data.orders %}
            <tr>
                <td colspan="11" style="text-align: center;">Ничего не найдено.</td>
            </tr>
            {% else %}
                {% for order in data.orders %}
                    <tr>
                        <td>{{ order.order_number }}</td>
                        <td>{{ order.get_order_status_display }}</td>
                        <td>{{ order.id }}</td>
                        <td>{{ order.get_order_type_display }}</td>
                        <td>{{ order.order_date.date|date:"d.m.Y" }}</td>
                        <td>{{ order.deadline_date.date|date:"d.m.Y" }}</td>
                        <td>{{ order.order_date|default:"нет" }}</td>
                        <td>
                            {% if order.contract_file %}
                                <a class="chat-button" href="{{ order.contract_file.url }}" download>скачать</a>
                            {% else %}
                                <span>отсутствует</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.invoice_file %}
                                <a class="chat-button" href="{{ order.invoice_file.url }}" download>скачать</a>
                            {% else %}
                                <span>отсутствует</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.order_status == "OVC" %}
                                <a href="{% url 'order_view' order.id %}" class="button chat-button">Проверить заполнение заказа</a>
                            {% elif order.order_status == "ESA" %}
                                <a href="{% url 'check_signing_exec' order.id %}" class="button chat-button">Проверить подписание договора</a>
                            {% elif order.order_status == "EGDS" %}
                                <a href="{% url 'check_gds_file_exec' order.id %}" class="button chat-button">Проверить файл GDS</a>
                            {% elif order.order_status == "POC" %}
                                <a href="{% url 'view_is_paid_exec' order.id %}" class="button chat-button">Проверка оплаты заказа</a>
                            {% elif order.order_status == "MPO" %}
                                <a href="{% url 'plates_in_stock' order.id %}" class="button chat-button">Передать заказ на производство</a>
                            {% elif order.order_status == "SO" %}
                                <a href="{% url 'shipping_is_confirm' order.id %}" class="button chat-button">Начать отгрузку пластин</a>
                            {% endif %}
                            <a href="{% url 'create_or_open_chat' order.id %}" class="button chat-button">
                                Перейти в чат
                                {% if has_unread_messages %}
                                    <span class="unread-icon">✉️</span>
                                {% endif %}
                            </a>
                            <a href="{% url 'check_the_order' order.id %}" class="button chat-button">
                                Просмотр заказа
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}       
        </table>
    </div>
    <br>
{% endblock %}
