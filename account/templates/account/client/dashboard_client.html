{% extends "base.html" %}

{% block title %}Личный кабинет{% endblock %}

{% block content %}

<h1>Личный кабинет<span class="caps">заказчика</span></h1>
<h2>Компания: {{ data.platform_name }}</h2>
<h2>Код заказчика: {{data.profile.id}}</h2>

<div class="header_content">
</div>
<br>
<div class="block_search">
    <form method="get" action="{% url 'generic_search_clients' %}">
        <input type="text" name="q" class="input_text" placeholder="Поиск по любым параметрам заказа" value="{{ request.GET.q }}">
        <button class="search-button" type="submit">Поиск</button>
    </form>
</div>

<div class="filter-block">
    <form method="get" action="{% url 'client_orders' %}" class="filter-form">
        {% if request.GET.q %}
            <input type="hidden" name="q" value="{{ request.GET.q }}">
        {% endif %}
        
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label">Сортировать по:</label>
                <select name="filter_by" class="filter-select">
                    <option value="">Выберите фильтр...</option>
                    <option value="order_number" {% if request.GET.filter_by == "order_number" %}selected{% endif %}>По номеру заказа</option>
                    <option value="status" {% if request.GET.filter_by == "status" %}selected{% endif %}>По статусу заказа</option>
                    <option value="created_at" {% if request.GET.filter_by == "created_at" %}selected{% endif %}>По дате создания</option>
                </select>
            </div>        
            <div class="filter-actions">
                <button type="submit" class="apply-button">Применить</button>
                {% if request.GET.filter_by or request.GET.q %}
                    <a href="{% url 'client_orders' %}" class="reset-button">
                        Сбросить фильтры
                    </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<div class="order-table-wrapper">
    <table border="1" class="order-table">
        <tr>
            <th>Номер заказа</th>
            <th>Статус заказа</th>
            <th>Код площадки</th>
            <th>Тип заказа</th>
            <th>Дата формирования заявки</th>
            <th>Срок выполнения по договору</th>
            <th>Договор</th>
            <th>Счет</th>
            <th>GDS</th>
            <th>Дата оплаты</th> 
            <th>Действия</th>
        </tr>
        {% if not data.orders %}
            <tr>
                <td colspan="11" style="text-align: center;">Заказов не найдено</td>
            </tr>
        {% else %}
            {% for order in data.orders %}
                <tr class="order-row">
                    <td>{{ order.order_number }}</td>
                    <td>{{ order.get_order_status_display }}</td>
                    <td>{{ order.platform_code.platform_code }}</td>
                    <td>{{ order.get_order_type_display }}</td>
                    <td>{{ order.order_date.date|date:"d.m.Y" }}</td>
                    <td>{{ order.deadline_date.date|date:"d.m.Y" }}</td>

                    <td>
                        {% if order.contract_file %}
                            <a class="chat-button" href="{{ order.contract_file.url }}" download>Скачать</a>
                        {% else %}
                            <span>Отсутствует</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if order.invoice_file %}
                            <a class="chat-button" href="{{ order.invoice_file.url }}" download>Скачать</a>
                        {% else %}
                            <span>Отсутствует</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if order.order_status == "OGDS" %}
                            <a class="chat-button" href="{% url 'add_gds' order.id %}">Загрузить GDS файл</a>
                        {% else %}
                            {% if order.GDS_file %}
                                <a class="chat-button" href="{{ order.GDS_file.url }}" download>Скачать</a>
                            {% else %}
                                <span>GDS не загружен</span>
                            {% endif %}
                        {% endif %}
                    </td>

                    <td>
                        {% if order.order_status == "PO" %}
                            <a class="chat-button" href="{% url 'is_paid' order.id %}">Оплатить</a>    
                        {% else %}
                            {% if order.is_paid == False %}
                                <span>Оплата недоступна</span>
                            {% else %}
                                <span>{{order.order_date.date|date:"d.m.Y" }}</span>
                            {% endif %}
                        {% endif %}
                    </td>

                    <td>
                        {% if order.order_status == "NFW" %}
                            <a href="{% url 'changes_in_order' order.id %}" class="button chat-button">Внести изменения в заказ</a>
                        {% elif order.order_status == "OA" or order.order_status == "SA" %}
                            <a href="{% url 'signing_agreement' order.id %}" class="button chat-button">Подтвердить подписание договора</a>
                        {% elif order.order_status == "CR" %}
                            <a href="{% url 'confirmation_receipt' order.id %}" class="button chat-button">Подтвердить получение пластин</a>
                        {% endif %}
                        <a href="{% url 'create_or_open_chat' order.id %}" class="button chat-button">
                            Перейти в чат
                            {% if has_unread_messages %}
                                <span class="unread-icon">✉️</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'check_the_order' order.id %}" class="button chat-button">
                            Просмотр заказа
                        </a>
                    </td>
                </tr>
            {% endfor %}
        {% endif %}
    </table>
</div>

<br/>
<div>
    <a href="{% url "new_order" %}" class="button">Новый заказ</a>
</div>

{% endblock %}
