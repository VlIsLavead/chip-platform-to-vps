{% extends "base.html" %}

{% block title %}Редактировать профиль{% endblock %}

{% block content %}
    <h1>Редактирование заказа</h1>
    <p>Заполните форму и прикрепите документы</p>
    <form method="post" enctype="multipart/form-data" id="orderForm" data-url="{% url 'load_data' %}">
        <p>Номер заказа {{order.order_number}}</p>
        <p>Creator {{ request.user.first_name|default:request.user.username }}</p>
        {% for field in order_form %}
            <div id="field-{{ field.name }}" {% if field.name == 'mask_name' %}style="display: none;"{% endif %}>
                <p>
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <span class="help-icon" style="cursor: pointer;" onclick="showHelpText('{{ field.help_text|escapejs }}')">
                            &#x3F;
                        </span>
                    {% endif %}
                    {% for error in field.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </p>
            </div>
        {% endfor %}
        {% csrf_token %}
        <p><input class="chat-button" type="submit" value="Сохранить"></p>
    </form>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
    $(document).ready(function () {
        document.getElementById('id_product_count').addEventListener('keydown', function(e) {
            if (['-', 'e', '+', '.'].includes(e.key)) {
                e.preventDefault();
            }
        });
        localStorage.removeItem('platform_code');
        localStorage.removeItem('substrate_type');
        localStorage.removeItem('thickness');
        localStorage.removeItem('diameter');
    
        function toggleMaskNameField() {
            const orderType = $("#id_order_type").val();
            const maskNameField = $("#field-mask_name");
            const maskNameInput = $("#id_mask_name");
            
            if (orderType === "REP") {
                maskNameField.show();
                maskNameInput.prop("required", true);
                maskNameInput.css("display", "");
            } else {
                maskNameField.hide();
                maskNameInput.prop("required", false);
                maskNameInput.val("");
            }
        }

        $("#id_order_type").change(toggleMaskNameField);
        toggleMaskNameField();

        function toggleMultiplanFileField() {
            const choiceField = $("#id_multiplan_dicing_plan");
            const fileField = $("#id_multiplan_dicing_plan_file").closest("p");
            if (choiceField.prop("checked")) {
                fileField.show();
            } else {
                fileField.hide();
            }
        }
        $("#id_multiplan_dicing_plan").change(toggleMultiplanFileField);
        toggleMultiplanFileField();

        window.showHelpText = function(text) {
            document.getElementById('helpText').innerText = text;
            document.getElementById('helpModal').style.display = 'block';
        }
        $('#closeHelpBtn').click(function() { $('#helpModal').hide(); });

        function toggleFields() {
            const probingVal = $('#id_dc_rf_probing_e_map').val();
            if (probingVal === 'No') {
                $('#id_dc_rf_probing_inking').prop('disabled', true).prop('checked', false);
                $('#id_visual_inspection_inking').prop('disabled', true).prop('checked', false);
            } else {
                $('#id_dc_rf_probing_inking').prop('disabled', false);
                $('#id_visual_inspection_inking').prop('disabled', false);
            }
        }
        toggleFields();

        function toggleFieldsForContainer() {
            const tabContainer = $('#id_wafer_deliver_format').val();
            const tabContainerValue = 'Кристаллы в таре';
            console.log(tabContainer)
            if (tabContainer === tabContainerValue) {
                $('#id_package_servce').prop('disabled', true).prop('checked', false);
            } else {
                $('#id_package_servce').prop('disabled', false);
            }
        }
        toggleFieldsForContainer();

        function loadTechnicalProcesses(platformId) {
            if (platformId) {
                $.ajax({
                    url: $("#orderForm").attr("data-url"),
                    data: { 'platform_id': platformId },
                    success: function(data) {
                        const $select = $("#id_technical_process");
                        $select.empty().append('<option value="">Выберите техпроцесс</option>');
                        if (data.technical_processes) {
                            data.technical_processes.forEach(p => {
                                $select.append($('<option></option>').val(p.id).text(p.name_process));
                            });
                        } else {
                            $select.append('<option value="">Нет доступных техпроцессов</option>');
                        }
                    }
                });

                $.ajax({
                    url: $("#orderForm").attr("data-url"),
                    data: { 'platform_id': platformId },
                    success: function(data) {
                        const $diameterField = $("#id_selected_diameter");
                        const currentValue = $diameterField.val();
                        $diameterField.empty().append('<option value="">---------</option>');
                        if (data.diameters) {
                            data.diameters.forEach(d => {
                                $diameterField.append(`<option value="${d.id}">${d.value} мм</option>`);
                            });
                        }
                        if (currentValue && $diameterField.find(`option[value="${currentValue}"]`).length) {
                            $diameterField.val(currentValue);
                        } else {
                            $diameterField.val('');
                        }
                    }
                });
            } else {
                $("#id_technical_process").empty().append('<option value="">Выберите платформу</option>');
                $("#id_selected_diameter").empty().append('<option value="">---------</option>');
            }
        }

        function loadThicknesses(substrateType) {
            if (substrateType) {
                $.ajax({
                    url: $("#orderForm").attr("data-url"),
                    data: { 'substrate_type': substrateType },
                    success: function(data) {
                        const $thicknessField = $("#id_selected_thickness");
                        $thicknessField.empty().append('<option value="">---------</option>');
                        if (data.thicknesses) {
                            data.thicknesses.forEach(t => {
                                $thicknessField.append(`<option value="${t.id}">${t.value}</option>`);
                            });
                        }
                    }
                });
            } else {
                $("#id_selected_thickness").empty().append('<option value="">---------</option>');
            }
        }

        function loadContainerOptions(waferFormat) {
            if (waferFormat) {
                $.ajax({
                    url: $("#orderForm").attr("data-url"),
                    data: { 'wafer_deliver_format': waferFormat },
                    success: function(data) {
                        const $containerField = $("#id_container_for_crystals");
                        $containerField.empty().append('<option value="">---------</option>');
                        if (data.container_for_crystals) {
                            data.container_for_crystals.forEach(c => {
                                $containerField.append(`<option value="${c.id}">${c.value}</option>`);
                            });
                        }
                    }
                });
            } else {
                $("#id_container_for_crystals").empty().append('<option value="">---------</option>');
            }
        }

        $("#id_platform_code").change(function () {
            const platformId = $(this).val();
            loadTechnicalProcesses(platformId);
        });

        $("#id_substrate_type").change(function () {
            const substrateType = $(this).val();
            loadThicknesses(substrateType);
        });

        $("#id_wafer_deliver_format").change(function () {
            const waferFormat = $(this).val();
            loadContainerOptions(waferFormat);
            toggleFieldsForContainer();
        });

        $('#id_dc_rf_probing_e_map').change(function () {
            toggleFields();
        });

        loadTechnicalProcesses($("#id_platform_code").val());
        loadThicknesses($("#id_substrate_type").val());
        loadContainerOptions($("#id_wafer_deliver_format").val());
    });
</script>
{% endblock %}