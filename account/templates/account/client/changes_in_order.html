{% extends "base.html" %}

{% block title %}Редактировать профиль{% endblock %}

{% block content %}
    <h1>Редактирование заказа</h1>
    <p>Заполните форму и прикрепите документы</p>
    <form method="post" enctype="multipart/form-data" id="orderForm" data-url="{% url 'load_data' %}">
        <p>Номер заказа {{order.order_number}}</p>
        <p>Creator {{ request.user.first_name|default:request.user.username }}</p>
        {% for field in order_form %}
            <div id="field-{{ field.name }}" {% if field.name == 'mask_name' %}style="display: none;"{% endif %}>
                <p>
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <span class="help-icon" style="cursor: pointer;" onclick="showHelpText('{{ field.help_text|escapejs }}')">
                            &#x3F;
                        </span>
                    {% endif %}
                    {% for error in field.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </p>
            </div>
        {% endfor %}
        {% csrf_token %}
        <p><input type="submit" value="Сохранить"></p>
    </form>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
    $(document).ready(function () {
        function toggleMaskNameField() {
            const orderType = $("#id_order_type").val();
            const maskNameField = $("#field-mask_name");
            const maskNameInput = $("#id_mask_name");
            
            if (orderType === "REP") {
                maskNameField.show();
                maskNameInput.prop("required", true);
                maskNameInput.css("display", "");
            } else {
                maskNameField.hide();
                maskNameInput.prop("required", false);
                maskNameInput.val("");
            }
        }

        $("#id_order_type").change(function () {
            toggleMaskNameField();
        });

        toggleMaskNameField();

        function toggleMultiplanFileField() {
            const choiceField = $("#id_multiplan_dicing_plan");
            const fileField = $("#id_multiplan_dicing_plan_file").closest("p");
            if (choiceField.prop("checked")) {
                fileField.show();
            } else {
                fileField.hide();
            }
        }

        toggleMultiplanFileField();

        $("#id_multiplan_dicing_plan").change(function () {
            toggleMultiplanFileField();
        });

        function loadSubstrates() {
            const substrate_type = $("#id_substrate_type").val();
            const url = $("#orderForm").attr("data-url");

            $.ajax({
                url: url,
                data: {
                    'substrate_type': substrate_type
                },
                success: function (data) {
                    $("#id_selected_thickness").html('<option value="">---------</option>');
                    $("#id_selected_diameter").html('<option value="">---------</option>');

                    data.thicknesses.forEach(function (thickness) {
                        $("#id_selected_thickness").append(
                            '<option value="' + thickness.id + '">' + thickness.value + '</option>'
                        );
                    });

                    data.diameters.forEach(function (diameter) {
                        $("#id_selected_diameter").append(
                            '<option value="' + diameter.id + '">' + diameter.value + '</option>'
                        );
                    });

                    // Восстановление сохранённых значений
                    const savedThickness = localStorage.getItem('thickness');
                    const savedDiameter = localStorage.getItem('diameter');

                    if (savedThickness) {
                        $("#id_selected_thickness").val(savedThickness);
                    }

                    if (savedDiameter) {
                        $("#id_selected_diameter").val(savedDiameter);
                    }
                },
                error: function () {
                    $("#id_selected_thickness").html('<option value="">---------</option>');
                    $("#id_selected_diameter").html('<option value="">---------</option>');
                }
            });
        }

        function loadContainerForCrystals() {
            const wafer_deliver_format = $("#id_wafer_deliver_format").val();
            const substrate_type = $("#id_substrate_type").val();  // Получаем выбранное значение substrate_type
            const url = $("#orderForm").attr("data-url");

            $.ajax({
                url: url,
                data: {
                    'wafer_deliver_format': wafer_deliver_format,
                    'substrate_type': substrate_type
                },
                success: function (data) {
                    $("#id_container_for_crystals").html('<option value="">---------</option>');
                    data.container_for_crystals.forEach(function (container) {
                        $("#id_container_for_crystals").append(
                            '<option value="' + container.id + '">' + container.value + '</option>'
                        );
                    });
                },
                error: function () {
                    $("#id_container_for_crystals").html('<option value="">---------</option>');
                }
            });
        }

        $("#id_wafer_deliver_format").change(function () {
            loadContainerForCrystals();
        });

        $("#id_substrate_type").change(function () {
            loadSubstrates();
        });

        if ($("#id_wafer_deliver_format").val()) {
            loadContainerForCrystals();
        }

        if ($("#id_substrate_type").val()) {
            loadSubstrates();
        }

        if (localStorage.getItem('substrate_type')) {
            const substrate_type = localStorage.getItem('substrate_type');
            $("#id_substrate_type").val(substrate_type).trigger("change");
        }

        $("#id_substrate_type").change(function () {
            localStorage.setItem('substrate_type', $(this).val());
        });

        $("#id_selected_thickness").change(function () {
            const thickness = $(this).val();
            localStorage.setItem('thickness', thickness);
        });

        $("#id_selected_diameter").change(function () {
            const diameter = $(this).val();
            localStorage.setItem('diameter', diameter);
        });
    });
</script>
{% endblock %}